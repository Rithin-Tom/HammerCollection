<!-- Bootstrap 5 CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<body style="
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background-image: url('https://i.pinimg.com/736x/fa/4a/fa/fa4afaac480367b0867308624a84fda9.jpg');
  background-size: cover;
  background-position: center;
  min-height: 100vh;
">

<div class="container-fluid">
  <div class="row">

    <!-- Sidebar -->
    <%- include('../partials/user/sideBar', { user: user }) %>

    <!-- Main Content -->
    <div class="col-12 col-md-9 d-flex justify-content-center align-items-center p-4">
      <div class="bg-white rounded-4 shadow p-4" style="width: 100%; border: 40px solid rgb(27 57 84); max-width: 800px;">

        <h3 class="text-center mb-4">Your Shopping Cart</h3>

        <!-- CART ITEM -->
         <% if ( !cart || cart.items?.length==0 ) { %>
          <div class="card mb-3">
          <div class="row g-0 align-items-center">
            <p>Your cart is empty add some....</p>

             </div>
        </div>
         <% } else { %>  
           <% cart.items.forEach(element => { %>
            <div class="card mb-3" id="item-<%= element.productId._id %>">
          <div class="row g-0 align-items-center">
              <div class="col-md-2 text-center">
               <img src="<%= element.productId.productImage[0] %>" class="img-fluid" alt="Product">
            </div>
                <div class="col-md-4">
                                    <div class="card-body">
                 <h6 class="card-title mb-1"><%= element.productId.productName %></h6>
               <p class="mb-1 text-muted small">Variant: Red, Size: M</p>
              </div>
        </div>

        <!-- Quantity controls -->
        <div class="col-md-2 text-center">
          <div class="input-group justify-content-center">
            <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity('<%= element.productId._id %>', 'decrease')">−</button>
            <input type="text" class="form-control form-control-sm text-center" style="max-width: 50px;" id="qty-<%= element.productId._id %>" value="<%= element.quantity %>" readonly>
            <button class="btn btn-sm btn-outline-secondary" onclick="changeQuantity('<%= element.productId._id %>', 'increase')">+</button>
          </div>
        </div>

        <div class="col-md-2 text-center">
          <%= '₹' +  element.price.toLocaleString('en-IN') %>
        </div>
 
        <div class="col-md-2 text-center">
          <button class="btn btn-sm btn-outline-danger" onclick="removeItem('<%= element.productId._id %>')">Remove</button>
        </div>
      </div>
    </div>
           
          <% }) %>
          
          <% } %>
          
        

        <!-- Repeat the above block for more cart items -->

        <!-- Summary -->
         <% if (cart) { %>
          <div class="mt-4 border-top pt-3">
          <div class="d-flex justify-content-between">
            <span>Subtotal</span>
            <span id="subTotal" >₹ <%= cart.totalPrice.toLocaleString('en-IN') %>  </span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Shipping</span>
            <span>₹50</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Tax</span>
            <span>₹90</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between fw-bold">
            <span>Total</span>
            <p>Total Items: <span id="totalItems"><%= cart.totalItems %></span></p>
            <% if (cart.totalItems ===0) { %>
              <p>Total Price: ₹<span >0</span></p>
             
             <% } else { %>
             
            <p>Total Price: ₹<span id="totalPrice"><%= (cart.totalPrice +=140 ).toLocaleString('en-IN')   %></span></p>
            <% } %>
          </div>
          
          <% } else { %>

             <div class="mt-4 border-top pt-3">
          <div class="d-flex justify-content-between">
            <span>Subtotal</span>
            <span  >₹0 </span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Shipping</span>
            <span>₹50</span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Tax</span>
            <span>₹90</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between fw-bold">
            <span>Total</span>
            <p>Total Items: <span>0</span></p>
              <p>Total Price: ₹<span >0</span></p> 
            <p>Total Price: ₹<span >></span></p>
          
          </div>

            <% } %>
          
        
          <div class="d-grid gap-2 mt-3">
            <a href="/shop" class="btn btn-secondary" style="text-decoration: none; color: white;">← Continue Shopping</a>
            <a href="/checkout" class="btn btn-success" style="text-decoration: none; color: white;">Proceed to Checkout</a>

          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

<script>
  async function changeQuantity(productId,action) {

     const qtyInput = document.getElementById(`qty-${productId}`);
     let currentQty = parseInt(qtyInput.value);

     let newQty = currentQty;
      if (action === 'increase' && currentQty < 5) newQty++;
      if (action === 'decrease' && currentQty > 1) newQty--;

      if (newQty === currentQty) {
       if (currentQty === 5 && action === 'increase') {
    Swal.fire({
         toast: true,
      position: 'top-end',
      icon: 'error',
      title: 'You can only add up to 5 items in the cart.',
      showConfirmButton: false,
      timer: 1500,
      timerProgressBar: true
    });
  }
  return;
}



      const res = await fetch('/cart/update',{
        method:"PUT",
        headers:{'content-type':'application/json'},
        body:JSON.stringify({
          productId,
          quantity:newQty
        })
      })

      const result = await res.json()

      if(result.success){
         qtyInput.value = newQty;
          let tot = result.totalPrice +140 
        document.getElementById('totalItems').textContent = result.totalItems;
        document.getElementById('subTotal').textContent = `${result.totalPrice}`;
        document.getElementById('totalPrice').textContent = `${tot} `;
      }else{
        Swal.fire({
          toast: true,
          position: 'top-end',
          icon: 'error',
          title: result.message ||'Out of Stock',
          showConfirmButton: false,
          timer: 1500,
          timerProgressBar: true
        });
      }
    
  }

  async function removeItem(productId) {

    const res = await fetch('/cart/delete',{
      method:"DELETE",
      headers:{'content-type':'application/json'},
      body:JSON.stringify({
        productId

      })
    })

    const result = await res.json();

    if(result.success){

      let itemDiv = document.getElementById(`item-${productId}`);


      if (itemDiv) {
        
        itemDiv.style.transition = "opacity 0.4s ease-out";
        itemDiv.style.opacity = 0;

        
        setTimeout(() => itemDiv.remove(), 1000);
      }

      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'success',
        title:  result.message,
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true
      });
      document.getElementById('totalItems').innerText = result.cart.totalItems;
      document.getElementById('totalPrice').innerText = result.cart.totalPrice;
      
    } else {
      Swal.fire({
       toast: true,
       position: 'top-end',
       icon: 'error',
       title: result.message ||'Failed to remove from the  cart:',
       showConfirmButton: false,
       timer: 1500,
       timerProgressBar: true
      });

    }
    
  }
</script>